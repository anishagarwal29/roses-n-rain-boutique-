import { GoogleGenAI } from "@google/genai";
import { ImageUpload } from "../types";

const GEMINI_API_KEY = import.meta.env.VITE_GOOGLE_API_KEY || '';

// Initialize the client
const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });

/**
 * Generates a virtual try-on image using Gemini.
 * @param personImage The image of the user.
 * @param clothingImage The image of the clothing item.
 * @returns The base64 data URL of the generated image.
 */
export const generateTryOnImage = async (
  personImage: ImageUpload,
  clothingImage: ImageUpload
): Promise<string> => {
  if (!personImage.base64 || !clothingImage.base64) {
    throw new Error("Images are missing base64 data.");
  }

  // Strip the data URL prefix (e.g., "data:image/jpeg;base64,")
  const personBase64 = personImage.base64.split(',')[1];
  const clothingBase64 = clothingImage.base64.split(',')[1];

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash-image',
      contents: {
        parts: [
          {
            text: `Perform a high-fidelity virtual try-on task for an Indian fashion boutique. 
            
            Inputs:
            1. 'Person Image': A photo of a customer.
            2. 'Garment Image': A photo of a specific piece of Indian ethnic clothing (e.g., Saree, Lehenga, Kurta, Sherwani).

            Task:
            Generate a photorealistic image of the person from the first image wearing the garment from the second image.

            STRICT CONSTRAINT CHECKLIST:
            1. [CRITICAL] COLOR FIDELITY: The color of the garment in the output MUST match the 'Garment Image' exactly. Do not apply filters or lighting that shifts the hue/saturation of the fabric.
            2. [CRITICAL] PATTERN PRESERVATION: Retain all embroidery, beadwork, prints, and texture details from the 'Garment Image'. Do not simplify or hallucinate new patterns.
            3. IDENTITY PRESERVATION: Maintain the person's exact face, skin tone, body shape, and pose.
            4. REALISTIC DRAPE: Wrap the Indian garment naturally around the body. If it is a Saree or Dupatta, ensure the folds and pleats follow the laws of physics and traditional draping styles.
            5. BACKGROUND: Keep the original background of the 'Person Image'.

            Output only the final image.`
          },
          {
            inlineData: {
              mimeType: personImage.mimeType,
              data: personBase64
            }
          },
          {
            inlineData: {
              mimeType: clothingImage.mimeType,
              data: clothingBase64
            }
          }
        ]
      }
    });

    // Extract image from response
    if (response.candidates && response.candidates.length > 0) {
      const candidate = response.candidates[0];
      if (candidate.content && candidate.content.parts) {
        for (const part of candidate.content.parts) {
          if (part.inlineData && part.inlineData.data) {
            return `data:image/png;base64,${part.inlineData.data}`;
          }
        }
      }
    }
    
    // Fallback if no image found directly in standard structure
    throw new Error("No image generated by the model.");

  } catch (error: any) {
    console.error("Gemini API Error:", error);
    throw new Error(error.message || "Failed to generate try-on image.");
  }
};